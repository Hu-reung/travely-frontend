import { type NextRequest, NextResponse } from "next/server"
import { generateText } from "ai"
import { openai } from "@ai-sdk/openai"

export async function POST(request: NextRequest) {
  try {
    const body = await request.json()
    const { title, keywords, photoCount } = body

    console.log("📥 AI 생성 요청:", { title, keywords, photoCount })

    if (!title || !keywords || !photoCount) {
      return NextResponse.json(
        { 
          success: false,
          error: "title, keywords, photoCount are required" 
        },
        { status: 400 }
      )
    }

    // ✅ 프롬프트 작성
    const prompt = `너는 평범한 20-30대 일반인이야. 여행 일기를 자연스럽고 편하게 작성해줘.

제목: ${title}
사진 개수: ${photoCount}개
키워드/태그: ${keywords}

🚨🚨🚨 절대적으로 중요한 규칙 (어떤 일이 있어도 반드시 지켜야 함!) 🚨🚨🚨
- 문단 개수는 무조건 정확히 ${photoCount}개만 작성!
- ${photoCount}개보다 많으면 절대 안 됨!
- ${photoCount}개보다 적어도 절대 안 됨!
- 제목이나 소제목 같은 추가 텍스트는 절대 작성하지 말 것!
- 오직 본문 문단 ${photoCount}개만 작성할 것!
- **반드시 한글로만 작성! 영어, 러시아어, 일본어 등 다른 언어는 절대 사용 금지!**
- **외래어나 고유명사(브랜드명, 지명 등)는 한글로 표기할 것!**

작성 스타일:
1. 문체와 톤 (중요!)
   - **일관된 반말 구어체 사용 (매우 중요!)**:
     * 문장 종결: "~했다", "~였다", "~됐다" 형태로 통일
     * ❌ 잘못된 예: "갔어", "맛있었어" (너무 친근), "~하더라", "~하며" (너무 딱딱)
     * ✅ 올바른 예: "갔다", "맛있었다", "좋았다", "예뻤다"
   - 과도하게 시적이거나 문학적인 표현 금지
   - "나"를 주어로 쓰되, 때로는 생략
   - 짧은 문장 위주로, 가끔 긴 문장 섞기
   - 개인 일기처럼 편하게, 하지만 문체는 일관되게

2. 감각적 묘사 (적당히!)
   - 시각: 색깔, 형태를 간단히 ("회색 하늘", "붉은 날개", "분홍색 음료")
   - 미각: 맛을 솔직하게 ("맛있었다", "달았다", "부드러웠다")
   - 과도한 수식어 지양 ("붉은 오렌지빛", "깊고 풍부한 향" 같은 표현 금지)
   - **키워드 해석 (매우 중요!)**:
     * 키워드를 정확히 해석하고 맥락에 맞게 사용할 것
     * 예: "내집" → 본인의 집, "우리집 고양이" → 내가 키우는 고양이
     * 예: "집사" → 내가 고양이 집사 (내가 키우는 것)
     * 브랜드명, 장소명을 키워드에서 찾아 언급
   - **위치 정보**:
     * 제목이나 키워드에 해외 지역명이 명확히 있으면 그 위치로 작성
     * 위치 정보가 전혀 없으면 → 한국 국내 여행으로 작성
     예: 제목 "부산 여행" → 부산에서의 경험
     예: 키워드에 국가/도시 없음 → 한국 어딘가로 작성

3. 감정 표현 (자연스럽게)
   - **작은따옴표 사용 금지 (매우 중요!)**:
     * ❌ 절대 금지: 감정이나 생각을 작은따옴표로 표현하지 말 것
     * ❌ 잘못된 예: "'진짜 귀엽다.' 싶어서", "'여기 예쁘다.' 생각했다", "'재밌었다.'"
     * ✅ 올바른 예: "진짜 귀여워서", "여기 예뻐서", "재밌어서"
   - **중요**: 감정이나 생각을 자연스럽게 서술형으로 표현
     * ❌ 잘못: "'배고프다.' 느꼈다"
     * ✅ 올바름: "배가 고팠다"
   - 감정을 과장하지 말고 솔직하게
   - "좋았다", "재밌었다", "기분 좋았다", "귀여워서", "예뻐서" 등 자연스럽게

4. 금지 표현 (매우 중요!)
   - ❌ "붉은 오렌지빛으로 물들어", "깊고 풍부한 향", "맛의 향연"
   - ❌ "가슴이 뭉클했다", "환한 빛을 띠었다", "시간의 흐름이 특별하게"
   - ❌ "저마다 다른 색으로 읽혀졌다", "겹겹이 쌓인 감정"
   - ❌ 과도하게 시적이고 감성적인 모든 표현
   - ✅ 대신: "예뻤다", "좋았다", "맛있었다", "재밌었다" 같은 단순한 표현 사용

5. 구조 (🚨 가장 중요! 절대 어기면 안 됨! 🚨)
   - **절대 규칙 1: 사진 개수 = 문단 개수 (정확히 ${photoCount}개만!)**
   - **절대 규칙 2: 각 문단은 해당 순서의 사진에 대한 내용만 작성**
   - **절대 규칙 3: 제목, 소제목, 부제 등 추가 텍스트 절대 작성 금지!**
   - 사진 1장 → 1문단만, 사진 2장 → 2문단만, 사진 ${photoCount}장 → ${photoCount}문단만
   - 1번째 문단 = 1번째 사진만, 2번째 문단 = 2번째 사진만, 3번째 문단 = 3번째 사진만
   - 다른 사진의 내용을 다른 문단에 섞지 말 것!
   - 문단이 시간 순서대로 자연스럽게 이어지도록 작성
   - **각 문단은 7-8문장 (총 700-800자 정도로 충분히 작성)**
   - 문단 사이는 빈 줄로 구분 (\\n\\n)
   - **절대 주의: 제목은 이미 있으니 본문만 작성할 것!**

6. 금지사항
   - 이모티콘, 이모지 절대 사용 금지
   - 과도한 문학적 표현 금지
   - 키워드를 억지로 다 넣지 말 것

예시 스타일 (일관된 반말 구어체):
"비행기를 처음 타봤다. 창밖으로 비가 내리고 있었고, 출발이 좀 지연됐다. 창가 자리에 앉아서 밖을 봤는데 생각보다 별로 안 무서웠다. 금방 출발할 것 같아서 기다렸다. 티웨이 비행기 날개가 빨간색이라 눈에 확 띄었다. 날씨가 안 좋았는데도 생각보다 괜찮았다."

❌ 잘못된 문체 (비일관적):
"남자친구랑 레스토랑에 갔어. 와인이 맛있었다. 창가에 앉아서 보며 좋았다. 이런 날이 있었으면 좋겠다."
→ "갔어"(친근), "맛있었다"(중립), "보며"(딱딱), "좋겠다"(반말) 섞임

✅ 올바른 문체 (일관적):
"남자친구랑 레스토랑에 갔다. 와인이 맛있었다. 창가에 앉아서 봤는데 좋았다. 이런 날이 계속 있으면 좋겠다."
→ 모두 "~했다", "~였다" 형태로 통일

키워드 해석 예시:
- 키워드 "내집, 고양이, 집사" → "집에서 우리 고양이랑 시간을 보냈다." (내가 키우는 고양이)
- 키워드 "친구집, 고양이" → "친구네 집에 놀러 갔다. 고양이가 있었다." (친구가 키우는 고양이)
- 키워드 "카페, 고양이" → "고양이 카페에 갔다." (카페 고양이)

🚨 최종 확인 🚨
- 응답 형식: 오직 본문 문단 ${photoCount}개만 작성
- 제목("스위트 펭귄 투어" 같은) 절대 작성하지 말 것!
- 소제목, 부제 절대 작성하지 말 것!
- 정확히 ${photoCount}개의 문단으로 구성된 일기 본문만 작성!`

    console.log("🚀 AI 호출 시작...")

    // ✅ AI 호출
    const result = await generateText({
      model: openai("gpt-4o-mini"),
      prompt,
      maxRetries: 2,
    })

    console.log("✅ AI 생성 완료:", result.text.trim())

    // ✅ 프론트에서 받는 필드명과 일치시킴
    return NextResponse.json({
      success: true,
      content: result.text.trim(),
    })
  } catch (error) {
    console.error("❌ AI 생성 오류:", error)
    
    const errorMessage = error instanceof Error ? error.message : "AI 다이어리 생성 실패"
    
    return NextResponse.json(
      {
        success: false,
        error: errorMessage,
      },
      { status: 500 }
    )
  }
}